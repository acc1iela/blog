---
import BaseLayout from '@/layouts/BaseLayout.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = (await getCollection('blog', ({ data }) => !data.draft))
    .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

  return posts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      prevPost: posts[index + 1] ?? null, // 古い記事
      nextPost: posts[index - 1] ?? null, // 新しい記事
    },
  }));
}

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await post.render();

const dateOptions: Intl.DateTimeFormatOptions = {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
};

const formattedDate = post.data.publishedAt.toLocaleDateString('ja-JP', dateOptions);
const formattedUpdatedAt = post.data.updatedAt?.toLocaleDateString('ja-JP', dateOptions);
---

<BaseLayout title={post.data.title} description={post.data.description} ogType="article">
  <article class="py-8">
    <header class="mb-8 text-center">
      <div class="text-sm text-gray-500 dark:text-gray-400 space-x-2">
        <time datetime={post.data.publishedAt.toISOString()}>
          {formattedDate}
        </time>
        {formattedUpdatedAt && (
          <>
            <span>|</span>
            <span>
              更新: <time datetime={post.data.updatedAt!.toISOString()}>{formattedUpdatedAt}</time>
            </span>
          </>
        )}
      </div>
      <h1 class="mt-2 text-3xl font-bold sm:text-4xl">
        {post.data.title}
      </h1>
      <div class="mt-4 flex justify-center flex-wrap gap-2">
        {post.data.tags.map((tag) => (
          <a
            href={`/blog/tag/${tag}`}
            class="px-3 py-1 text-sm rounded-full bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-accent hover:text-white transition-colors"
          >
            {tag}
          </a>
        ))}
      </div>
    </header>

    <div class="lg:grid lg:grid-cols-[1fr_200px] lg:gap-8">
      <div class="prose prose-lg dark:prose-invert max-w-none min-w-0">
        <Content />
      </div>

      {headings.length > 0 && (
        <aside class="hidden lg:block">
          <div class="sticky top-24">
            <TableOfContents headings={headings} />
          </div>
        </aside>
      )}
    </div>

    <!-- 前後記事ナビ -->
    {(prevPost || nextPost) && (
      <nav class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between gap-4">
          {prevPost ? (
            <a
              href={`/blog/${prevPost.id}/`}
              class="group flex-1 p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-accent dark:hover:border-accent transition-colors"
            >
              <span class="text-sm text-gray-500 dark:text-gray-400">← 前の記事</span>
              <p class="mt-1 font-medium group-hover:text-accent transition-colors line-clamp-2">
                {prevPost.data.title}
              </p>
            </a>
          ) : (
            <div class="flex-1" />
          )}
          {nextPost ? (
            <a
              href={`/blog/${nextPost.id}/`}
              class="group flex-1 p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-accent dark:hover:border-accent transition-colors text-right"
            >
              <span class="text-sm text-gray-500 dark:text-gray-400">次の記事 →</span>
              <p class="mt-1 font-medium group-hover:text-accent transition-colors line-clamp-2">
                {nextPost.data.title}
              </p>
            </a>
          ) : (
            <div class="flex-1" />
          )}
        </div>
      </nav>
    )}
  </article>
</BaseLayout>
